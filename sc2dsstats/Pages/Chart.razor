@page "/chart"
@using Microsoft.AspNetCore.Components
@using System.ComponentModel
@using sc2dsstats.Data
@using sc2dsstats.Models
@using pax.s2decode.Models
@inject ChartService _chart
@inject ChartStateChange chartChanged
@inject DSdyn_filteroptions  _options
@inject ScanStateChange _scan
@inject StartUp _startUp
@implements IDisposable

<div id="dv_head" class="container-fluid">
    <div class="row mb-2">
        <div class="btn-group">
            <div class="mr-2">
                <button name="btn_mode" class="btn btn-sm btn-primary btn-block" @onclick="@(() => _options.Mode = "Winrate")">Winrate</button>
            </div>
            <div class="mr-2">
                <button name="btn_mode" class="btn btn-sm btn-primary btn-block" @onclick="@(() => _options.Mode = "MVP")">MVP</button>
            </div>
            <div class="mr-2">
                <button name="btn_mode" class="btn btn-sm btn-primary btn-block" @onclick="@(() => _options.Mode = "DPS")">DPS</button>
            </div>
            <div class="mr-2">
                <button name="btn_mode" class="btn btn-sm btn-primary btn-block" @onclick="@(() => _options.Mode = "Synergy")">Synergy</button>
            </div>
            <div class="mr-2">
                <button name="btn_mode" class="btn btn-sm btn-primary btn-block" @onclick="@(() => _options.Mode = "AntiSynergy")">AntiSynergy</button>
            </div>
            <div class="mr-2">
                <button name="btn_mode" class="btn btn-sm btn-primary btn-block" @onclick="@(() => _options.Mode = "Timeline")">Timeline</button>
            </div>
        </div>
        <MatTooltip Tooltip="Check for replay creater/uploader matchup only or uncheck for all matchups in the replays" Position="@MatTooltipPosition.Bottom">
            <div class="custom-control custom-checkbox mr-2" @ref="context.Current">
                <input type="checkbox" class="custom-control-input" name="cb_player" id="cb_player" @bind="@_options.Player" />
                <label class="custom-control-label" for="cb_player">Player</label>
            </div>
        </MatTooltip>
        <MatTooltip Tooltip="Start the y-axis of the chart at zero" Position="@MatTooltipPosition.Bottom">
            <div class="custom-control custom-checkbox mr-2" @ref="context.Current">
                <input type="checkbox" class="custom-control-input" name="cb_zero" id="cb_zero" @bind="@_options.BeginAtZero" />
                <label class="custom-control-label" for="cb_zero">BeginatZero</label>
            </div>
        </MatTooltip>
    </div>
    <div class="row">
        <div class="btn-group">
            <div class="mr-3">
                <button class="btn-sm btn-light btn-block" @onclick="@ToggleFilter">Filter</button>
            </div>
            <div class="mr-2">
                <button class="btn-sm btn-secondary btn-block" @onclick="@(() => Gametime(1))">This month</button>
            </div>
            <div class="mr-2">
                <button class="btn-sm btn-secondary btn-block" @onclick="@(() => Gametime(2))">Last month</button>
            </div>
            <div class="mr-2">
                <button class="btn-sm btn-secondary btn-block" @onclick="@(() => Gametime(3))">This year</button>
            </div>
            <div class="mr-2">
                <button class="btn-sm btn-secondary btn-block" @onclick="@(() => Gametime(4))">All</button>
            </div>
        </div>
        <div class="mr-2">
        </div>
        <div class="form-group mr-2" style="visibility: @_isLoading">
            <p>Loading ...</p>
        </div>
        @if (_options.Cmdrinfo.ContainsKey(interest))
        {
        <div class="form-group mr-2">
            <span class="badge badge-danger mr-2">
                Total games<br />@_options.Cmdrinfo[interest].Games
            </span>
        </div>
        <div class="form-group mr-2">
            <span class="badge badge-danger mr-2">
                Total WR<br />@_options.Cmdrinfo[interest].Winrate
            </span>
        </div>
        <div class="form-group mr-2">
            <span class="badge badge-danger mr-2">
                Duration<br />@_options.Cmdrinfo[interest].AverageGameDuration
            </span>
        </div>
        }
    </div>
    <div class="@FilterClass" id="div_filter">
        <div class="card card-body">
            <Filter />
        </div>
    </div>
</div>
<div id="dv_btn" class="container-fluid">
    <div class="row">
        <div>
            <div>
                @foreach (var ent in DSdata.s_races)
                {
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox"
                               class="custom-control-input"
                               name="CmdrIcons"
                               value=@ent
                               id="cb_@ent"
                               @onchange="@( async () => await IconClick(@ent))" />
                        <label class="custom-control-label" for="cb_@ent">
                            <img alt="img_@ent" longdesc="img_@ent" src="@DSdata.GetIcon(@ent)" width="30" height="30" />
                            @ent
                        </label>
                    </div>
                }
            </div>
        </div>
        <!--<div class="chart" style="min-width: 800px !important;  min-height: 600px !important;">-->

        <div class="@CmdrClass w-75" id="chart-wrapper">
            <Cmdrs />
        </div>
        <div class="@ChartClass w-75">
            <canvas id="canvas"></canvas>
            <!--<button class="btn btn-sm btn-light" @onclick="@(() => CopyToClipboard())">Copy to clipboard</button>-->
        </div>

    </div>

    <div>
        <div class="row">
            <div>
                <div style="width: 400px;">
                    <p>@DSdata.INFO[@_options.Mode]</p>
                </div>
            </div>
            <div>
                @if (_options.Cmdrinfo.ContainsKey("ALL"))
                {
                <div style="width: 400px; font-size: 12px; overflow: hidden; margin-left: 10px;">
                    <p>@_options.Cmdrinfo["ALL"].FilterInfo</p>
                </div>
                }
            </div>
            <button class="btn-sm btn-secondary" href="#chart-wrapper" @onclick="@ToggleCmdrs">Cmdrs played</button>
        </div>

    </div>
</div>

@code {

    [Parameter]
    public string info { get; set; }

    static string chartdata = String.Empty;
    string FilterClass => _options.Filter ? null : "collapse";
    string CmdrClass => cmdrvis ? null : "collapse";
    string ChartClass => cmdrvis ? "collapse" : null;
    List<string> cmdricons;
    string interest = "ALL";
    bool cmdrvis = false;
    string _isLoading = "visible";
    object _lock;


    private Dictionary<string, bool> IsChecked = new Dictionary<string, bool>();

    void ToggleFilter()
    {
        _options.Filter = !_options.Filter;
    }

    void ToggleCmdrs()
    {
        cmdrvis = !cmdrvis;
        if (_options.Cmdrinfo.ContainsKey("ALL"))
            chartChanged.CmdrCount = new Dictionary<string, int>(_options.Cmdrinfo["ALL"].CmdrCount);
        chartChanged.Update = !chartChanged.Update;
    }

    protected override async Task OnInitializedAsync()
    {
        _lock = new object();
        cmdricons = new List<string>();
        _options.DefaultFilter(_startUp);
        _options.Build = "ALL";
        if (!_options.Cmdrinfo.ContainsKey("ALL"))
        { _options.Cmdrinfo.Add("ALL", new CmdrInfo()); }

        foreach (var ent in DSdata.s_races)
        {
            IsChecked.Add(ent, false);
        }
        _options.PropertyChanged += OptionChanged;

        await _chart.GetChartBase();
        _options.Player = true;
    }

    private async void stateChange(object sender, EventArgs args)
    {
        await InvokeAsync(() => StateHasChanged());
    }

    async void CopyToClipboard()
    {
        await _chart.CopyToClipboard("canvas");
    }

    private void Gametime(int i)
    {
        string startdate = "0";
        string enddate = "0";

        DateTime dFirstDayOfThisMonth = DateTime.Today.AddDays(-(DateTime.Today.Day - 1));

        if (i == 1)
        {

            startdate = dFirstDayOfThisMonth.ToString("yyyy-MM-dd");
            enddate = DateTime.Today.ToString("yyyy-MM-dd");
        }
        else if (i == 2)
        {
            DateTime dLastDayOfLastMonth = dFirstDayOfThisMonth.AddDays(-1);
            DateTime dFirstDayOfLastMonth = dFirstDayOfThisMonth.AddMonths(-1);
            startdate = dFirstDayOfLastMonth.ToString("yyyy-MM-dd");
            enddate = dLastDayOfLastMonth.ToString("yyyy-MM-dd");
        }
        else if (i == 3)
        {
            startdate = new DateTime(DateTime.Now.Year, 1, 1).ToString("yyyy-MM-dd");
            enddate = DateTime.Today.ToString("yyyy-MM-dd");
        }
        else if (i == 4)
        {
            startdate = new DateTime(2018, 1, 1).ToString("yyyy-MM-dd");
            enddate = DateTime.Today.ToString("yyyy-MM-dd");
        }

        if (DateTime.Parse(startdate) == _options.Startdate)
        {
            _options.Enddate = DateTime.Parse(enddate);
        }
        else if (DateTime.Parse(enddate) == _options.Enddate)
        {
            _options.Startdate = DateTime.Parse(startdate);
        }
        else
        {
            _options.DOIT = false;
            _options.Startdate = DateTime.Parse(startdate);
            _options.DOIT = true;
            _options.Enddate = DateTime.Parse(enddate);
        }
    }

    private async Task IconClick(string cmdr)
    {
        _isLoading = "visible";
        await InvokeAsync(() => StateHasChanged());
        IsChecked[cmdr] = !IsChecked[cmdr];

        _options.Icons = IsChecked.Where(x => x.Value == true).ToArray().Count();
        _options.Interest = cmdr;
        interest = _options.Interest;

        if (IsChecked[cmdr] == true)
        {
            cmdricons.Add(cmdr);
            await _chart.AddDataset();
        }
        else
        {
            cmdricons.Remove(cmdr);
            await _chart.RemoveDataset();
        }

        _options.Icons = cmdricons.Count();

        string activecmdr = "";
        if (cmdricons.Count > 0)
        {
            activecmdr = cmdricons[cmdricons.Count - 1];
            if (_options.Cmdrinfo.ContainsKey(activecmdr))
            {
                interest = activecmdr;
            } else
            {
                interest = "ALL";
            }
        }
        else
        {
            interest = "ALL";
        }
        _isLoading = "hidden";
        
        await InvokeAsync(() => StateHasChanged());
    }

    private async void OptionChanged(object sender, PropertyChangedEventArgs e)
    {
        if (_options.DOIT == true)
        {
            if (e != null && e.PropertyName != "Interest")
            {
                if (e.PropertyName != "Filter") { 
                    _isLoading = "visible";
                    await InvokeAsync(() => StateHasChanged());
                    await _chart.RebuildChart();
                    chartChanged.CmdrCount = new Dictionary<string, int>(_options.Cmdrinfo["ALL"].CmdrCount);
                    chartChanged.Update = !chartChanged.Update;
                    _isLoading = "hidden";
                }
                await InvokeAsync(() => StateHasChanged());
            }
        }
    }

    public void Dispose()
    {
        _options.PropertyChanged -= OptionChanged;
    }

}
